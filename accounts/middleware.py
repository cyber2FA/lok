from django.utils.timezone import now  # โ ุงุณุชูุฑุงุฏ `now` ูุฌูุจ ุงูููุช ุงูุญุงูู
from django.conf import settings  # โ ุงุณุชูุฑุงุฏ `settings` ูููุตูู ุฅูู ุฅุนุฏุงุฏุงุช Django
from django.shortcuts import redirect  # โ ุงุณุชูุฑุงุฏ `redirect` ูุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุจุนุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
from django.contrib.auth import logout  # โ ุงุณุชูุฑุงุฏ `logout` ูุฅููุงุก ุฌูุณุฉ ุงููุณุชุฎุฏู
from django.contrib import messages  # โ ุงุณุชูุฑุงุฏ `messages` ูุฅุธูุงุฑ ุฑุณุงูุฉ ุชูุจูู ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
import datetime  # โ ุงุณุชูุฑุงุฏ `datetime` ููุนุงูุฌุฉ ุงูููู ุงูุฒูููุฉ

class AutoLogoutMiddleware:
    """
    โ ููุฏู ููุฑ (Middleware) ูููู ุจุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู ุชููุงุฆููุง ุจุนุฏ ูุชุฑุฉ ูุนููุฉ ูู ุนุฏู ุงููุดุงุท.
    - ูุชุญูู ูู ูุดุงุท ุงููุณุชุฎุฏู ุนูุฏ ูู ุทูุจ (`request`).
    - ุฅุฐุง ุชุฌุงูุฒ ุงููุณุชุฎุฏู ุงููููุฉ ุงูุฒูููุฉ ุงููุญุฏุฏุฉ (`SESSION_COOKIE_AGE`)ุ ูุชู ุชุณุฌูู ุฎุฑูุฌู.
    - ูุชู ูุณุญ ุจูุงูุงุช ุงูุฌูุณุฉ ุจุงููุงูู ูุญูุงูุฉ ุงูุฎุตูุตูุฉ.
    - ูุชู ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุน ุฅุธูุงุฑ ุฑุณุงูุฉ ุชูุถูุญูุฉ.
    """

    def __init__(self, get_response):
        """
        โ ูุชู ุงุณุชุฏุนุงุก ูุฐุง ุงูููููุฆ (`__init__`) ุนูุฏ ุชุญููู ุงูููุฏู ููุฑ.
        - `get_response`: ููุณุชุฎุฏู ููุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุงุฏูุฉ.
        """
        self.get_response = get_response

    def __call__(self, request):
        """
        โ ูุชู ุชูููุฐ ูุฐู ุงูุฏุงูุฉ ูุน ูู ุทูุจ (`request`) ููุฑุณูู ุงููุณุชุฎุฏู ุฅูู ุงูุณูุฑูุฑ.
        - ูุชู ุงูุชุญูู ูู ุญุงูุฉ ุงูุฌูุณุฉ ููุฏุฉ ุนุฏู ุงููุดุงุท.
        - ูุชู ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู ุฅุฐุง ุชุฌุงูุฒ ูุฏุฉ ุงูุฎููู ุงููุณููุญ ุจูุง.
        """

        if request.user.is_authenticated:  # โ ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู
            last_activity_str = request.session.get('last_activity')  # โณ ุฌูุจ ููุช ุขุฎุฑ ูุดุงุท ููุญุชูู ูุตู

            if last_activity_str:
                try:
                    # ๐ ุชุญููู ุงููุต ุงููุฎุฒู ุฅูู `datetime` ูู `ISO format`
                    last_activity = datetime.datetime.fromisoformat(last_activity_str)

                    # ๐ ุญุณุงุจ ูุฏุฉ ุงูุฎููู ุจุงูุซูุงูู
                    inactive_duration = (now() - last_activity).total_seconds()

                    # โ ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ูุฏุฉ ุงูุฎููู ุชุฌุงูุฒุช ุงููููุฉ ุงููุณููุญ ุจูุง
                    if inactive_duration > settings.SESSION_COOKIE_AGE:
                        logout(request)  # โ ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู
                        request.session.flush()  # ๐ด ุญุฐู ุฌููุน ุจูุงูุงุช ุงูุฌูุณุฉ ูุญูุงูุฉ ุงูุฎุตูุตูุฉ
                        messages.warning(request, "โ๏ธ ุชู ุชุณุฌูู ุฎุฑูุฌู ุชููุงุฆููุง ุจุณุจุจ ุนุฏู ุงููุดุงุท ููุฏุฉ ุทูููุฉ.")  
                        return redirect('homepage')  # ๐ ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ

                except ValueError:
                    # ๐ ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ ูู ุงูุชุญูููุ ูุนูุฏ ุถุจุท ุงูููุช
                    request.session['last_activity'] = now().isoformat()

            # โณ ุชุญุฏูุซ ููุช ุขุฎุฑ ูุดุงุท ูููุณุชุฎุฏู ูุชุญูููู ุฅูู `ISO format`
            request.session['last_activity'] = now().isoformat()

        return self.get_response(request)  # โ ุงูุณูุงุญ ุจุชูุฑูุฑ ุงูุทูุจ ุฅูู ุงูุชุทุจูู ุฅุฐุง ูู ููู ููุงู ุชุณุฌูู ุฎุฑูุฌ
