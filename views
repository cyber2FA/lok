 from django.shortcuts import render, redirect
from django.contrib import messages
from django.http import JsonResponse, HttpResponseRedirect
from django.db import IntegrityError
from django.contrib.auth.decorators import login_required
from django.contrib.auth.views import LoginView  
from .forms import CustomUserCreationForm, AccountProfileForm  
from .models import CustomUser, AccountProfile  
import logging
from django.urls import reverse

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
logger = logging.getLogger(__name__)

### âœ… **ğŸ”¹ Ø§Ù„ÙÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©**
def homepage(request):
    return render(request, 'homepage.html')

def dashboard(request):
    return render(request, 'dashboard.html')

def pending_activation(request):
    return render(request, 'pending_activation.html')

### âœ… **ğŸ”¹ ÙÙŠÙˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµ**
class CustomLoginView(LoginView):
    template_name = 'login.html'  

### âœ… **ğŸ”¹ ÙÙŠÙˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø¬Ø§Ø­**
def register(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST, request.FILES)

        # âœ… Ø¯Ø¹Ù… AJAX Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            if form.is_valid():
                return JsonResponse({'valid': True})
            else:
                errors = {field: [error for error in error_list] for field, error_list in form.errors.items()}
                return JsonResponse({'valid': False, 'errors': errors}, status=400)

        # âœ… Ø¹Ù†Ø¯ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¯ÙŠ ÙˆÙ„ÙŠØ³ Ø¹Ø¨Ø± `AJAX`
        if form.is_valid():
            try:
                # âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
                email = form.cleaned_data.get('email')
                phone_number = form.cleaned_data.get('phone_number')

                if CustomUser.objects.filter(email=email).exists():
                    messages.error(request, "âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯ Ø¢Ø®Ø±.")
                    return render(request, 'register.html', {'form': form})

                if CustomUser.objects.filter(phone_number=phone_number).exists():
                    messages.error(request, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø¢Ø®Ø±.")
                    return render(request, 'register.html', {'form': form})

                # âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
                user = form.save(commit=False)
                user.is_active = False  # âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ¨Ù‚Ù‰ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø­ØªÙ‰ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø´Ø±Ù
                user.save()

                # âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† `AccountProfile` Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
                profile, created = AccountProfile.objects.get_or_create(
                    user=user,
                    defaults={
                        'email': user.email,
                        'phone_number': user.phone_number,
                        'resume': user.resume
                    }
                )

                if not created:
                    logger.warning(f"âš ï¸ AccountProfile Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user.email}, Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.")

                request.session.flush()  # âœ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                
                messages.success(request, "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø´Ø±Ù Ø¹Ù„Ù‰ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ.")

                # âœ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                return HttpResponseRedirect(reverse('pending_activation'))   

            except IntegrityError as e:
                logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {e}")
                messages.error(request, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")
                return redirect('register')  # Ù…Ù†Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ø®Ø§Ø·Ø¦Ø©

            except Exception as e:
                logger.error(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {e}")
                messages.error(request, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")
                return redirect('register')  # Ù…Ù†Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ø®Ø§Ø·Ø¦Ø©

        else:
            messages.error(request, "âš ï¸ ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŒ ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.")

    else:
        form = CustomUserCreationForm()

    return render(request, 'register.html', {'form': form})

### âœ… **ğŸ”¹ ÙÙŠÙˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ**
@login_required
def update_profile(request):
    try:
        profile = request.user.account_profile  

        if request.method == 'POST':
            form = AccountProfileForm(request.POST, request.FILES, instance=profile)
            if form.is_valid():
                form.save()
                messages.success(request, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!")
                return redirect('dashboard')
            else:
                messages.error(request, "âš ï¸ ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.")
        else:
            form = AccountProfileForm(instance=profile)

        return render(request, 'update_profile.html', {'form': form})

    except AccountProfile.DoesNotExist:
        messages.error(request, "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ!")
        return redirect('dashboard')

### âœ… **ğŸ”¹ ÙÙŠÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ±ÙŠØ¯Ø©**
def validate_username(request):
    username = request.GET.get("value", "").strip()
    if CustomUser.objects.filter(username=username).exists():
        return JsonResponse({"exists": True, "message": "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!"})
    return JsonResponse({"exists": False, "message": "âœ… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ§Ø­!"})

def validate_email(request):
    email = request.GET.get("value", "").strip()
    if CustomUser.objects.filter(email=email).exists() or AccountProfile.objects.filter(email=email).exists():
        return JsonResponse({"exists": True, "message": "âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„!"})
    return JsonResponse({"exists": False, "message": "âœ… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªØ§Ø­!"})

def validate_phone_number(request):
    phone_number = request.GET.get("value", "").strip()
    if CustomUser.objects.filter(phone_number=phone_number).exists() or AccountProfile.objects.filter(phone_number=phone_number).exists():
        return JsonResponse({"exists": True, "message": "âŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„!"})
    return JsonResponse({"exists": False, "message": "âœ… Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ØªØ§Ø­!"})
